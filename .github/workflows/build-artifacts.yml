name: Build and publish artifacts

on:
  push:
    branches: [ main, master ]

# Allow workflow to write repository contents when using GITHUB_TOKEN (best-effort).
# For pushing from forks or when GITHUB_TOKEN is insufficient, provide a PAT in repo secrets.
permissions:
  contents: write

jobs:
  build-artifacts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, pdo_mysql, zip, gd

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Composer
        run: |
          if ! command -v composer >/dev/null 2>&1; then
            EXPECTED_SIG=$(curl -sS https://composer.github.io/installer.sig)
            php -r "copy('https://getcomposer.org/installer', 'composer-setup.php');"
            ACTUAL_SIG=$(php -r "echo hash_file('sha384', 'composer-setup.php');")
            if [ "$EXPECTED_SIG" != "$ACTUAL_SIG" ]; then
              echo 'ERROR: Invalid composer installer signature' >&2
              exit 1
            fi
            php composer-setup.php --install-dir=/usr/local/bin --filename=composer
            php -r "unlink('composer-setup.php');"
          fi

      - name: Install PHP deps and create vendor archive
        run: |
          composer install --no-dev --prefer-dist --optimize-autoloader --no-interaction --no-progress
          tar -czf vendor.tar.gz vendor

      - name: Install Node deps and build public and archive
        run: |
          npm ci --prefer-offline --no-audit --progress=false
          npm run build
          tar -czf public.tar.gz public

      - name: Create artifacts branch and push archives
        env:
          GIT_EMAIL: actions@github.com
          GIT_NAME: GitHub Actions
        run: |
          git config user.email "$GIT_EMAIL"
          git config user.name "$GIT_NAME"
          # Ensure archives exist
          if [ ! -f vendor.tar.gz ] || [ ! -f public.tar.gz ]; then
            echo "Artifacts not found in workspace:";
            ls -la || true;
            exit 1;
          fi

          # Move artifacts to temporary safe location
          mkdir -p /tmp/artifacts
          mv vendor.tar.gz public.tar.gz /tmp/artifacts/

          # Create or switch to orphan artifacts branch and remove tracked files
          git checkout --orphan artifacts || git checkout artifacts
          git rm -rf . || true

          # Move artifacts back into repo root and commit
          mv /tmp/artifacts/vendor.tar.gz /tmp/artifacts/public.tar.gz ./
          git add -f vendor.tar.gz public.tar.gz
          git commit -m "chore: publish build artifacts" || true
          # Prefer using a PAT stored in repo secret ACTIONS_PAT for pushing.
          if [ -n "${{ secrets.ACTIONS_PAT }}" ]; then
            git push --force "https://x-access-token:${{ secrets.ACTIONS_PAT }}@github.com/${{ github.repository }}" HEAD:artifacts
          else
            git push --force origin HEAD:artifacts
          fi
